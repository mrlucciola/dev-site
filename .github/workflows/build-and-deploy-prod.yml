name: Push Production Build

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag Name"
        required: true
        default: "latest"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout QA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get latest tag
        id: get_tag
        run: echo "TAG_NAME=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT

      - name: Init Bun
        uses: oven-sh/setup-bun@v1
      - name: Install deps
        run: bun install
      - name: Build prod
        run: |
          NODE_ENV=production
          PUBLIC_URL=https://portfolio.mrlucciola.com
          bun run build

      - name: Checkout prod
        uses: actions/checkout@v4
        with:
          repository: mrlucciola/portfolio-page-prod
          token: ${{ secrets.PORTFOLIO_PROD }}
          path: portfolio-page-prod

      - name: Copy build files
        run: |
          mkdir -p production-repo
          rm -rf production-repo/*
          cp -r dist/* production-repo/
      - name: Commit and push to Production repo
        run: |
          cd production-repo
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Update prod build for ${{ steps.get_tag.outputs.TAG_NAME }}"
          git remote set-url origin git@github.com:mrlucciola/portfolio-page-prod.git
          
          git push
          git tag ${{ steps.get_tag.outputs.TAG_NAME }}
          git push --tags
